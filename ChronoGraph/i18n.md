# ChronoGraph 国际化与本地化（i18n）实施计划

本文档规划如何让应用默认跟随系统语言显示，并在应用内设置中支持用户手动切换显示语言（即时生效、可持久化）。

- 目标语言（第一阶段）：简体中文（zh-Hans）、英文（en）
- 兼容范围：iOS 15+/macOS 12+（SwiftUI）
- 成功标准：
  - 首次启动默认选择与系统偏好最匹配的语言；
  - 用户可在设置中选择“跟随系统/简体中文/English”；
  - 切换语言无需重启应用，立即更新 UI；
  - 字符串、日期/数字格式、导出图片中的文案均正确本地化。

## 架构设计

1) 资源层（Resource）
- 使用 Localizable.strings + Localizable.stringsdict 提供可翻译文本和复数/变量插值。
- 目录结构：
  - zh-Hans.lproj/Localizable.strings, Localizable.stringsdict
  - en.lproj/Localizable.strings, Localizable.stringsdict
- 在 Xcode 中为目标 Target 启用本地化（Project -> Info -> Localizations）。

2) 语言解析（Resolution）
- 有用户手动选择时：以用户选择为准；
- 否则：使用 `Bundle.main.preferredLocalizations.first` 选出与当前包资源最匹配的语言；
- 若无匹配：回退为 `en`。

3) 状态管理（State）
- 构建 `LanguageManager: ObservableObject` 保存语言偏好与有效 Locale：
  - 偏好类型：System（跟随系统）或 Fixed(languageCode)。
  - 持久化位置：UserDefaults（key: `app.language.preference`）。
  - 有效 Locale：当为 System 时，取包内最佳匹配；当为 Fixed 时，使用对应 `Locale(identifier:)`。
  - 通过 SwiftUI 环境注入：`.environment(\.locale, manager.effectiveLocale)`。

4) UI 集成（UI Wiring）
- 在 `ChronoGraphApp.swift` 中初始化 `@StateObject var languageManager` 并注入环境 locale。
- 新增“设置”视图中的语言选择器（Picker）：
  - 选项：跟随系统（System）、简体中文（zh-Hans）、English（en）。
  - 变更时更新 `LanguageManager`，即时刷新 UI。

5) 代码层替换（Usage）
- 文案统一改为 `Text("key")` 或 `NSLocalizedString("key", comment: "...")`；
- 日期/数字：使用 `.environment(\.locale, ...)` 后，`Text(date, format: ...)`、`Date.FormatStyle`、`NumberFormatter` 自动跟随；
- 导出/分享等非视图层字符串：显式传入 `Locale` 与 `Bundle` 进行格式化与取词条。

## 关键类型与示例代码

AppLanguage 与偏好表示：

```swift
enum AppLanguage: String, CaseIterable, Identifiable {
    case system // 跟随系统
    case zhHans = "zh-Hans"
    case en = "en"

    var id: String { rawValue }

    var displayName: String {
        switch self {
        case .system: return NSLocalizedString("language.system", comment: "Follow System")
        case .zhHans: return "简体中文"
        case .en: return "English"
        }
    }

    var locale: Locale? {
        switch self {
        case .system: return nil
        case .zhHans: return Locale(identifier: "zh-Hans")
        case .en: return Locale(identifier: "en")
        }
    }

    static let supportedExplicit: [AppLanguage] = [.zhHans, .en]
}
```

LanguageManager：

```swift
final class LanguageManager: ObservableObject {
    @Published private(set) var effectiveLanguageCode: String = "en"
    @Published private(set) var effectiveLocale: Locale = Locale(identifier: "en")
    @Published var preference: AppLanguage = .system {
        didSet { persistAndRecompute() }
    }

    private let key = "app.language.preference"

    init() {
        load()
        recomputeEffective()
    }

    private func load() {
        if let raw = UserDefaults.standard.string(forKey: key),
           let pref = AppLanguage(rawValue: raw) ?? (raw == "system" ? .system : nil) {
            preference = pref
        } else {
            preference = .system
        }
    }

    private func persistAndRecompute() {
        UserDefaults.standard.set(preference.rawValue, forKey: key)
        recomputeEffective()
    }

    private func recomputeEffective() {
        if case .system = preference {
            // 与包内可用本地化匹配
            let best = Bundle.main.preferredLocalizations.first ?? "en"
            effectiveLanguageCode = best
            effectiveLocale = Locale(identifier: best)
        } else if let loc = preference.locale {
            effectiveLanguageCode = preference.rawValue
            effectiveLocale = loc
        }
        // 广播后，SwiftUI 通过 environment(\.locale, ...) 即时刷新
        objectWillChange.send()
    }
}
```

在 `ChronoGraphApp.swift` 注入环境：

```swift
@main
struct ChronoGraphApp: App {
    @StateObject private var languageManager = LanguageManager()

    var body: some Scene {
        WindowGroup {
            ContentView()
                .environment(\.locale, languageManager.effectiveLocale)
                .environmentObject(languageManager)
        }
    }
}
```

设置页语言选择器（示意）：

```swift
struct LanguageSettingsView: View {
    @EnvironmentObject var languageManager: LanguageManager

    var body: some View {
        Form {
            Picker(NSLocalizedString("settings.language", comment: "Language"), selection: $languageManager.preference) {
                Text(AppLanguage.system.displayName).tag(AppLanguage.system)
                ForEach(AppLanguage.supportedExplicit) { lang in
                    Text(lang.displayName).tag(lang)
                }
            }
        }
    }
}
```

字符串资源示例：

- Localizable.strings (en)
  - "settings.language" = "Language";
  - "language.system" = "Follow System";
- Localizable.strings (zh-Hans)
  - "settings.language" = "显示语言";
  - "language.system" = "跟随系统";

日期格式使用示例（会随环境 Locale 自动变化）：

```swift
Text(event.startDate, format: .dateTime.year().month().day())
```

导出图片中的本地化（伪代码）：

```swift
let locale = languageManager.effectiveLocale
let formatter = DateFormatter()
formatter.locale = locale
formatter.dateStyle = .medium
let dateText = formatter.string(from: date)
let title = NSLocalizedString("export.title", comment: "Export Title")
```

## 改造清单（逐步落地）

1) 工程与资源
- 在 Target -> Info -> Localizations 中新增 English 与 Chinese (Simplified)；
- 新建 `en.lproj/Localizable.strings`、`zh-Hans.lproj/Localizable.strings`；必要时新增 `Localizable.stringsdict`；
- 检查 Info.plist：保持 `CFBundleDevelopmentRegion`（如 `en`）一致。

2) 代码基础设施
- 新增 `LanguageManager.swift`（放置于 `Managers/`）；
- 在 `ChronoGraphApp.swift` 注入 `.environment(\.locale, ...)` 与 `.environmentObject(languageManager)`；
- 新增 `LanguageSettingsView.swift`（放置于 `Views/`），并在设置入口处导航到该视图。

3) 文案替换
- 使用搜索定位硬编码字符串：
  - 搜索模式：`Text\("[^"]+"\)`、`"[\u4e00-\u9fa5A-Za-z].*"`、`NSLocalizedString` 缺失处；
- 为 UI 文案建立 key，写入两语言的 Localizable.strings；
- 将视图中的硬编码改为 `Text("key")` 或 `NSLocalizedString("key", ...)`；

4) 时间/数字与业务逻辑
- 统一改用 `Date.FormatStyle` 与 `NumberFormatter`，并确保 `locale` 来源于 `LanguageManager` 环境；
- 导出/分享（如 `ImageExportManager`）中所有文案使用 `NSLocalizedString` 与注入的 `Locale` 格式化；

5) 测试验证
- 场景用例：
  - A. 跟随系统：系统中文/英文切换，应用首次启动语言正确；
  - B. 应用内切换：设置页切换后 UI 即时更新；
  - C. 复数/占位：`stringsdict` 对应的数量变化正确；
  - D. 回退策略：删除某语言某 key，是否安全回退到英文；
  - E. 导出图片：文字与日期格式与界面一致；
  - F. 冷启动持久化：重启后仍保持用户选择；

6) 发布准备
- App Store Connect 中勾选对应本地化；
- 截图与描述按语言提交；

## 约定与最佳实践

- key 命名：`<区域>.<页面>.<元素>`，例如：`settings.language.title`；
- 避免在代码中拼接句子，改用带占位的完整句（stringsdict）；
- 所有新文案必须落库（CI 可加简单脚本比对未使用/未翻译 key）；
- 字体与排版：确保中文字体回退良好，避免导出图片截断；
- 右到左语言暂不在本阶段范围，后续可按需扩展。

## 时间评估（粗略）

- 资源与基础设施：0.5 天
- 文案清单与替换：0.5–1 天（取决于现有硬编码规模）
- 导出/分享适配：0.5 天
- 测试与修边：0.5 天

合计：约 2–2.5 天。

## 风险与回退

- 风险：遗漏文案导致混合语言；
- 缓解：默认英文回退、测试用例覆盖、上线前字符串扫描；
- 回退：保留开关（可在设置中临时隐藏语言切换入口），快速修正词条可通过热修复发布。
