# ChronoGraph 项目进度总结（截至 2025-09-08）

## 1. 当前代码功能概览（高层）
已实现核心：
- 只读日历数据接入（EventKit），含授权流程与日历多选/分组折叠。
- 预设日期范围：今天 / 3 天 / 7 天 / 14 天，切换即刷新。
- 三种隐私显示模式：隐藏（不透明）、缩略、完整；影响列表与导出内容。
- 多日事件列表（按日分组 + “今天”高亮 + 可折叠空白日）。
- 高分辨率长图导出（ImageRenderer + 回退 CG 快照），随后系统分享。
- 设置页：日历选择入口、折叠空白日期开关、版本占位信息。
- 用户偏好持久化：隐私模式 / 日期范围 / 已选日历 / 折叠空白日。
- 分享增强：自定义 UIActivityItemSource（改进预览/文件投递）。
- 基础并发安全：事件加载令牌避免竞态覆盖。

尚未实现：水印、免费/专业版分级、主题系统、多布局（周网格等）、PDF 导出、组件（Widget）、Siri/快捷指令、隐私政策入口、自适配多栏、导出后复制/保存按钮 UI、水印与高级功能解锁逻辑、品牌化视觉主题。

## 2. 详细功能清单与实现说明
- 授权：iOS17+ 使用 requestFullAccessToEvents；iOS16 回退 requestAccess(.event)。统一状态布尔包装。
- 日历选择：按 source 分组 + 优先级排序；支持折叠/全选/清空；首次默认全选；持久化标识。
- 日期范围：枚举向前固定跨度（不支持“本周”语义与任意自定义区间）。
- 隐私模式：
  - 隐藏：用忙闲状态替换标题，仅显示彩条 + 状态。
  - 缩略：标题 + 时间 + 忙闲徽记；隐藏位置/备注。
  - 完整：额外显示位置（行内）与备注（详情弹窗）。
- 事件模型：包装 EKEvent，扩展 busy/free/tentative/unavailable 映射颜色与本地化标签。
- 列表视图：全量填充日期（保持空日结构），可选择隐藏空日占位行；“今天”侧边色条 + 背景淡层；点击事件出现详情 sheet。
- 导出：同构再渲染（WYSIWYG）单一“multiDay”类型；确定性宽度 + 动态测高 + 缩放上限（2x 与 16384px 像素防护）。Catalyst 分支使用 layer.render 防 Metal 断言。
- 分享：调用自定义 activity item，首选 JPEG（体积）回退 PNG；无用户格式选择。
- 额外方法（无 UI）：复制到剪贴板、保存到相册。
- UI 结构：底部工具栏 Menu 控件（日期/隐私/导出）；设置页面承载日历选择与偏好。
- 无网络、无外部存储；纯本地处理。

## 3. 与 PRD 功能需求对照
P1：
- FR-01 日历集成：完成（缺少前置信任说明界面）。
- FR-02 日期范围：部分（仅固定预设，无“本周”/自定义）。
- FR-03 隐私模式：完成（UI 形式与 PRD 建议的三段控件不同）。
- FR-04 高保真图像：完成（含缩放策略与回退）。
- FR-05 分享导出：部分（系统分享 OK；缺少显式“保存图像”“拷贝”按钮交互）。
P2：
- FR-06 极简设计：部分（基础干净；缺少品牌化主题/动画打磨）。
- FR-07 核心流程：部分（步骤少，但菜单多一层点击）。
- FR-08 主题与定制：未开始。
P3：
- FR-09 多平台自适应：部分（统一 SwiftUI；缺少 iPad/Mac 分栏/大屏优化）。

扩展/商业：
- 水印：未开始。
- 免费增值逻辑与高级解锁：未开始。
- 隐私政策入口：未开始。
- 未来路线图（小组件 / App Intents / PDF / 多布局）：未开始。

## 4. 主要差距与风险
- 日期范围灵活性不足（缺自定义与“本周”语义）。
- 缺少水印与收费路径，后插入可能影响导出结构。
- 主题/品牌缺位，影响差异化与升级动机。
- 导出后操作不完整（无直接复制/保存 UI）。
- 多布局/周视图缺失，限制使用场景。
- 无隐私政策链接，影响审核合规。
- 自适应与桌面体验不足，降低多设备价值感。
- 国际化不统一（中英混合如 all-day）。

## 5. 当前实现优势
- 模块分离：CalendarManager / ImageExportManager / 事件模型清晰。
- 导出管线已考虑缩放与 Catalyst 差异，后续扩展易插入水印/主题。
- 隐私模式集中枚举，便于复用到新布局。
- 日历分组与折叠逻辑增强可用性。
- 无网络依赖，隐私与审核风险低。

## 6. 优先级下一步建议（MVP 闭环）
1. 水印（免费版）+ 条件开关（预留专业版）。
2. 导出后操作面板：复制 / 保存 / 再分享。
3. 将隐私模式改为 SegmentedControl（减少点击）。
4. 日期范围补充：This Week（当周周一~周日）+ 自定义区间结构占位。
5. Onboarding/授权说明页（一次性弹层或首屏卡片）。
6. 隐私政策链接（设置 & 首次授权前）。

次级：
7. 主题系统（默认 + 预留专业版主题）。
8. 周网格/压缩布局（为多布局扩展铺路）。
9. 自适应主框架（iPad 分栏 / Mac 优化）。
10. 水印与主题的抽象导出 DSL（ExportConfiguration + ExportContent 协议）。

## 7. FR 覆盖矩阵（速览）
| FR | 状态 | 说明 |
|----|------|------|
| FR-01 | 完成 | 只读集成 + 选择 |
| FR-02 | 部分 | 仅固定预设 |
| FR-03 | 完成 | 三模式逻辑完整 |
| FR-04 | 完成 | ImageRenderer + 回退 |
| FR-05 | 部分 | 分享有，缺保存/复制 UI |
| FR-06 | 部分 | 基础极简，缺品牌化 |
| FR-07 | 部分 | 菜单多一步 |
| FR-08 | 未开始 | 主题缺失 |
| FR-09 | 部分 | 缺大屏适配 |
| 水印/收费 | 未开始 | 架构位未占位 |
| 隐私政策 | 未开始 | 无入口 |
| 路线图功能 | 未开始 | 组件/PDF 等 |

## 8. 建议的轻量架构调整
- ExportConfiguration：集中 privacyMode / dateRange / theme / watermarkEnabled。
- ExportContent 协议：body + 标识符，便于插拔不同布局。
- WatermarkOverlay：与主内容解耦，可复用到 PDF。
- DateRange 扩展：Preset + custom(DateInterval)。

## 9. 快速收益（低成本高价值）
- 增加导出后操作条（复制/保存按钮）。
- 添加“本周”日期逻辑（周一 ~ 周日）。
- 本地化“all-day”→“全天”。
- 添加水印占位文本（未解锁时启用）。
- SegmentedControl 切换隐私模式。

## 10. 延后风险
- 迟加水印/收费导致导出视图重构成本上升。
- 用户形成菜单操作路径，后期优化感知变化成本。
- 缺少隐私政策可能导致审核驳回周期。
- 缺主题和差异化在发布初期影响转化与记忆点。

## 11. 总结
核心“日历隐私可视化 + 高保真导出”路径已跑通，现存主要缺口集中在：商业化封装（水印/收费）、可用性优化（更快切换控件）、展示差异化（主题/布局）、合规元素（隐私政策）与适配扩展。按优先序补齐上述缺口后，可形成一个聚焦、可审核、具升级空间的 MVP。
